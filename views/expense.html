<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expense Tracker</title>
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <h2>Add Expense</h2>
    <form id="expenseForm">
      <input
        type="number"
        id="amount"
        name="amount"
        placeholder="Amount"
        required
      />
      <select id="category" name="category" required>
        <option value="fuel">Fuel</option>
        <option value="movie">Movie</option>
        <option value="sports">Sports</option>
        <option value="rent">Rent</option>
      </select>
      <input
        type="text"
        id="description"
        name="description"
        placeholder="Description"
        required
      />
      <button type="submit">Add Expense</button>
    </form>
    <h3>All Expenses</h3>
    <ul id="expenseList"></ul>

    <!-- HTML near .premium-div -->
    <div class="premium-div">
      <div id="premiumInfo"></div>
      <button class="premium-btn" id="premiumBtn">Get Premium</button>
      <!-- New button to show leaderboard (hidden by default) -->
      <button id="showLeaderboardBtn" style="display: none; margin-left: 10px">
        Show Leaderboard
      </button>
    </div>

    <!-- Leaderboard modal (hidden by default) -->

    <h3>Leaderboard</h3>
    <ul id="leaderboardList"></ul>

    <!------------------------------------------------- Js --------------------------------------------------->
    <!------------------------------------------------- Js --------------------------------------------------->
    <!------------------------------------------------- Js --------------------------------------------------->

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      const form = document.getElementById("expenseForm");
      const list = document.getElementById("expenseList");
      const token = localStorage.getItem("token");

      if (!token) {
        alert("Please login first!");
        window.location.href = "login.html";
      }

      // add exp
      async function addExpense(e) {
        e.preventDefault();
        const data = {
          amount: document.getElementById("amount").value,
          category: document.getElementById("category").value,
          description: document.getElementById("description").value,
        };

        try {
          await axios.post("http://localhost:3000/expense/addExpense", data, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          getExpenses();
          form.reset();
        } catch (error) {
          if (error.response && error.response.status === 401) {
            alert("Session expired. Please login again.");
            localStorage.removeItem("token");
            window.location.href = "login.html";
          } else {
            console.error("Error adding expense:", error);
          }
        }
      }
      // get exp
      async function getExpenses() {
        try {
          const res = await axios.get(
            "http://localhost:3000/expense/getExpense",
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          list.innerHTML = "";
          res.data.forEach((exp) => {
            const li = document.createElement("li");
            li.textContent = `${exp.amount} - ${exp.category} - ${exp.description}`;
            list.appendChild(li);
          });
        } catch (error) {
          console.error("Error fetching expenses:", error);
          if (error.response && error.response.status === 401) {
            alert("Session expired. Please login again.");
            localStorage.removeItem("token");
            window.location.href = "login.html";
          }
        }
      }
      // payment
      const premiumBtn = document.getElementById("premiumBtn");
      const showLeaderboardBtn = document.getElementById("showLeaderboardBtn");
      const closeLeaderboard = document.getElementById("closeLeaderboard");
      const premiumInfo = document.getElementById("premiumInfo");

      premiumBtn.addEventListener("click", async () => {
        try {
          const orderRes = await axios.post(
            "http://localhost:3000/payment/create-order",
            {},
            { headers: { Authorization: `Bearer ${token}` } }
          );

          const { orderId, amount, currency, key } = orderRes.data;

          const options = {
            key,
            amount,
            currency,
            name: "Expense Tracker Premium",
            description: "Upgrade to Premium",
            order_id: orderId,
            handler: async function (response) {
              const verifyRes = await axios.post(
                "http://localhost:3000/payment/verify",
                {
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_signature: response.razorpay_signature,
                },
                { headers: { Authorization: `Bearer ${token}` } }
              );

              if (verifyRes.data.success) {
                alert("Payment Successful! You are now a Premium User.");
                window.location.reload();
              } else {
                alert("Payment verification failed.");
              }
            },
            theme: { color: "#528FF0" },
          };

          const rzp = new Razorpay(options);
          rzp.open();
        } catch (error) {
          console.error("Payment error:", error);
          alert("Error initiating payment.");
        }
      });

      // async function checkPremiumStatus() {
      //   const res = await axios.get("http://localhost:3000/user/details", {
      //     headers: { Authorization: `Bearer ${token}` },
      //   });
      //   if (res.data.isPremium) {
      //     document.querySelector(".premium-div").innerHTML =
      //       "<p>You are a Premium User ðŸŒŸ</p>";
      //   }
      // }

      async function checkPremiumStatus() {
        try {
          const res = await axios.get("http://localhost:3000/user/details", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (res.data.isPremium) {
            // show premium status
            premiumInfo.innerHTML =
              "<strong>You are a Premium User ðŸŒŸ</strong>";
            // hide buy button and show leaderboard button
            document.getElementById("premiumBtn").style.display = "none";
            showLeaderboardBtn.style.display = "inline-block";
          } else {
            premiumInfo.innerHTML = "";
            document.getElementById("premiumBtn").style.display =
              "inline-block";
            showLeaderboardBtn.style.display = "none";
          }
        } catch (err) {
          console.error("Error checking premium:", err);
        }
      }

      async function fetchLeaderboard() {
        try {
          const res = await axios.get(
            "http://localhost:3000/premium/leaderboard",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          const leaderboardList = document.getElementById("leaderboardList");
          leaderboardList.innerHTML = "";

          const data = res.data.leaderboard || [];

          data.forEach((item, index) => {
            const li = document.createElement("li");
            li.textContent = `${index + 1}. Name -> ${
              item.name
            } | Total Exp -> ${item.totalAmount}`;
            leaderboardList.appendChild(li);
          });
        } catch (err) {
          console.error("Error fetching leaderboard:", err);
          if (err.response && err.response.status === 403) {
            alert("Leaderboard is only for premium users.");
          }
        }
      }

      form.addEventListener("submit", addExpense);
      getExpenses();
      checkPremiumStatus();
      showLeaderboardBtn.addEventListener("click", fetchLeaderboard);
    </script>
  </body>
</html>
