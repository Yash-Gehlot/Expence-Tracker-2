<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expense Tracker Dashboard</title>
    <link rel="stylesheet" href="/index.css" />
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  </head>

  <body class="expense-page-body">
    <div class="expense-main-container">
      <!-- Header Section -->
      <header class="expense-header">
        <h1>Expense Tracker</h1>
        <div class="expense-header-right">
          <div class="expense-premium-section">
            <div id="premiumInfo" class="expense-premium-info"></div>
            <button
              class="expense-btn expense-btn-premium"
              id="premiumBtn"
              style="display: none"
            >
              Get Premium
            </button>
            <button
              class="expense-btn expense-btn-leaderboard"
              id="showLeaderboardBtn"
              style="display: none"
            >
              Show Leaderboard
            </button>
          </div>

          <div id="authButtons">
            <button
              class="expense-btn expense-btn-login"
              id="loginBtn"
              style="display: none"
            >
              Login
            </button>

            <div
              class="expense-user-dropdown"
              id="userDropdownContainer"
              style="display: none"
            >
              <button class="expense-user-icon-btn" id="userIconBtn">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              </button>
              <div class="expense-dropdown-menu" id="userDropdown">
                <a href="profile.html" class="expense-dropdown-item">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  View Profile
                </a>
                <a href="#" class="expense-dropdown-item" id="logoutBtn">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                  </svg>
                  Logout
                </a>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Add Expense Form -->
      <section class="expense-form-section" id="expenseFormSection">
        <h2>Add New Expense</h2>
        <form id="expenseForm" class="expense-form">
          <div class="expense-form-group">
            <input
              type="number"
              id="amount"
              name="amount"
              placeholder="Amount"
              required
            />
          </div>
          <div class="expense-form-group">
            <select id="category" name="category">
              <option value="">AI Category</option>
              <option value="fuel">Fuel</option>
              <option value="movie">Movie</option>
              <option value="sports">Sports</option>
              <option value="rent">Rent</option>
              <option value="food">Food</option>
              <option value="travel">Travel</option>
              <option value="shopping">Shopping</option>
              <option value="health">Health</option>
              <option value="entertainment">Entertainment</option>
              <option value="work">Work</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="expense-form-group">
            <input
              type="text"
              id="description"
              name="description"
              placeholder="Description"
              required
            />
          </div>
          <div class="expense-form-group">
            <input type="text" id="note" name="note" placeholder="Note" />
          </div>
          <button type="submit" class="expense-btn expense-btn-primary">
            Add Expense
          </button>
        </form>
      </section>

      <!-- Expenses List Section -->
      <section class="expense-list-section" id="expenseListSection">
        <div class="expense-section-header">
          <h3>All Expenses</h3>
          <div class="expense-controls">
            <label for="pageSizeSelector">Show:</label>
            <select id="pageSizeSelector" class="expense-page-selector">
              <option value="2">2</option>
              <option value="5">5</option>
              <option value="8">8</option>
              <option value="10">10</option>
            </select>
            <button
              class="expense-btn expense-btn-download"
              id="downloadexpense"
            >
              Download File
            </button>
          </div>
        </div>

        <ul id="expenseList" class="expense-list"></ul>

        <!-- Pagination -->
        <div class="expense-pagination">
          <button class="expense-btn expense-btn-secondary" id="prevPage">
            Previous
          </button>
          <span id="pageInfo" class="expense-page-info"></span>
          <button class="expense-btn expense-btn-secondary" id="nextPage">
            Next
          </button>
        </div>
      </section>

      <!-- Leaderboard Section -->
      <section class="expense-leaderboard-section" id="leaderboardSection">
        <h3>Leaderboard</h3>
        <ul id="leaderboardList" class="expense-leaderboard-list"></ul>
      </section>
    </div>

    <script>
      const form = document.getElementById("expenseForm");
      const list = document.getElementById("expenseList");
      const descriptionInput = document.getElementById("description");
      const categorySelect = document.getElementById("category");
      const token = localStorage.getItem("token");

      let timer = null;
      let isPremiumUser = false;
      let currentPage = parseInt(localStorage.getItem("currentPage")) || 1;
      let pageSize = parseInt(localStorage.getItem("pageSize")) || 2;
      let isLoggedIn = false;

      function checkAuthStatus() {
        if (token) {
          isLoggedIn = true;
          document.getElementById("loginBtn").style.display = "none";
          document.getElementById("userDropdownContainer").style.display =
            "block";
          checkPremiumStatus();
          getExpenses();
        } else {
          isLoggedIn = false;
          document.getElementById("loginBtn").style.display = "inline-block";
          document.getElementById("userDropdownContainer").style.display =
            "none";
          document.getElementById("premiumBtn").style.display = "none";
          document.getElementById("showLeaderboardBtn").style.display = "none";
        }
      }

      function requireAuth(action) {
        if (!isLoggedIn) {
          alert("Please login first to " + action + "!");
          window.location.href = "login.html";
          return false;
        }
        return true;
      }

      document
        .getElementById("loginBtn")
        .addEventListener("click", function () {
          window.location.href = "login.html";
        });

      document.getElementById("pageSizeSelector").value = pageSize;

      descriptionInput.addEventListener("input", function () {
        if (!requireAuth("use AI category suggestions")) return;

        const description = descriptionInput.value;
        clearTimeout(timer);
        timer = setTimeout(function () {
          getCategoryFromAI(description);
        }, 1000);
      });

      function getCategoryFromAI(description) {
        if (description.length < 3) return;

        axios
          .post(
            "http://localhost:3000/expense/suggestCategory",
            { description: description },
            { headers: { Authorization: `Bearer ${token}` } }
          )
          .then(function (response) {
            const suggestedCategory = response.data.category;
            const options = categorySelect.options;
            for (let i = 0; i < options.length; i++) {
              if (options[i].value === suggestedCategory) {
                categorySelect.value = suggestedCategory;
                break;
              }
            }
          })
          .catch(function (error) {
            console.log("Error getting category:", error);
          });
      }

      const userIconBtn = document.getElementById("userIconBtn");
      const userDropdown = document.getElementById("userDropdown");
      const logoutBtn = document.getElementById("logoutBtn");

      if (userIconBtn) {
        userIconBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          userDropdown.classList.toggle("show");
        });
      }

      document.addEventListener("click", function (e) {
        if (
          userDropdown &&
          !userDropdown.contains(e.target) &&
          !userIconBtn.contains(e.target)
        ) {
          userDropdown.classList.remove("show");
        }
      });

      if (logoutBtn) {
        logoutBtn.addEventListener("click", function (e) {
          e.preventDefault();
          if (confirm("Are you sure you want to logout?")) {
            localStorage.removeItem("token");
            localStorage.removeItem("pageSize");
            localStorage.removeItem("currentPage");
            window.location.href = "login.html";
          }
        });
      }

      function addExpense(e) {
        e.preventDefault();
        if (!requireAuth("add expenses")) return;

        const data = {
          amount: document.getElementById("amount").value,
          category: document.getElementById("category").value,
          description: document.getElementById("description").value,
          note: document.getElementById("note").value,
        };

        axios
          .post("http://localhost:3000/expense/addExpense", data, {
            headers: { Authorization: `Bearer ${token}` },
          })
          .then(function () {
            getExpenses();
            form.reset();
          })
          .catch(function (error) {
            if (error.response && error.response.status === 401) {
              alert("Session expired. Please login again.");
              localStorage.removeItem("token");
              window.location.href = "login.html";
            } else {
              console.error("Error adding expense:", error);
            }
          });
      }

      function getExpenses() {
        if (!isLoggedIn) {
          list.innerHTML =
            "<li style='text-align: center; color: #666;'>Please login to view your expenses</li>";
          return;
        }

        axios
          .get(
            `http://localhost:3000/expense/getExpense?page=${currentPage}&limit=${pageSize}`,
            { headers: { Authorization: `Bearer ${token}` } }
          )
          .then(function (res) {
            const totalPages = res.data.totalPages;

            if (currentPage > totalPages && totalPages > 0) {
              currentPage = totalPages;
              localStorage.setItem("currentPage", currentPage);
              getExpenses();
              return;
            }

            list.innerHTML = "";

            if (res.data.expenses.length === 0) {
              list.innerHTML =
                "<li style='text-align: center; color: #666;'>No expenses found. Add your first expense!</li>";
            } else {
              res.data.expenses.forEach(function (exp) {
                const li = document.createElement("li");
                li.innerHTML = `
                <span>${exp.amount} - ${exp.category} - ${exp.description} ${exp.note}</span>
                <button onclick="deleteExpense(${exp.id})">Delete</button>
              `;
                list.appendChild(li);
              });
            }

            const totalPagesCount = res.data.totalPages || 0;
            const currentPageNum = res.data.currentPage || 1;

            document.getElementById(
              "pageInfo"
            ).textContent = `Page ${currentPageNum} of ${
              totalPagesCount === 0 ? 1 : totalPagesCount
            }`;

            document.getElementById("prevPage").disabled =
              currentPageNum === 1 || totalPagesCount === 0;
            document.getElementById("nextPage").disabled =
              currentPageNum === totalPagesCount || totalPagesCount === 0;
          })
          .catch(function (error) {
            console.error("Pagination error:", error);
            if (error.response && error.response.status === 401) {
              alert("Session expired. Please login again.");
              localStorage.removeItem("token");
              window.location.href = "login.html";
            }
          });
      }

      function deleteExpense(id) {
        if (!requireAuth("delete expenses")) return;
        if (!confirm("Are you sure you want to delete this expense?")) return;

        axios
          .delete(`http://localhost:3000/expense/deleteExpense/${id}`, {
            headers: { Authorization: `Bearer ${token}` },
          })
          .then(function () {
            getExpenses();
            if (isPremiumUser) {
              fetchLeaderboard();
            }
          })
          .catch(function (error) {
            console.error("Delete error:", error);
            alert("Failed to delete expense");
          });
      }

      function download() {
        if (!requireAuth("download expenses")) return;

        axios
          .get("http://localhost:3000/user/download", {
            headers: { Authorization: token },
          })
          .then(function (response) {
            if (response.status === 201) {
              const a = document.createElement("a");
              a.href = response.data.fileUrl;
              a.download = "myexpense.csv";
              a.click();
            }
          })
          .catch(function (err) {
            console.log(err);
          });
      }

      function checkPremiumStatus() {
        axios
          .get("http://localhost:3000/user/details", {
            headers: { Authorization: `Bearer ${token}` },
          })
          .then(function (res) {
            isPremiumUser = res.data.isPremium;

            if (res.data.isPremium) {
              document.getElementById("premiumInfo").innerHTML =
                "<strong>You are a Premium User ðŸŒŸ</strong>";
              document.getElementById("premiumBtn").style.display = "none";
              document.getElementById("showLeaderboardBtn").style.display =
                "inline-block";
            } else {
              document.getElementById("premiumInfo").innerHTML = "";
              document.getElementById("premiumBtn").style.display =
                "inline-block";
              document.getElementById("showLeaderboardBtn").style.display =
                "none";
            }
          })
          .catch(function (err) {
            console.error("Error checking premium:", err);
          });
      }

      function initiatePremiumPayment() {
        if (!requireAuth("upgrade to premium")) return;

        axios
          .post(
            "http://localhost:3000/payment/create-order",
            {},
            { headers: { Authorization: `Bearer ${token}` } }
          )
          .then(function (orderRes) {
            const { orderId, amount, currency, key } = orderRes.data;

            const options = {
              key: key,
              amount: amount,
              currency: currency,
              name: "Expense Tracker Premium",
              description: "Upgrade to Premium",
              order_id: orderId,
              handler: function (response) {
                axios
                  .post(
                    "http://localhost:3000/payment/verify",
                    {
                      razorpay_order_id: response.razorpay_order_id,
                      razorpay_payment_id: response.razorpay_payment_id,
                      razorpay_signature: response.razorpay_signature,
                    },
                    { headers: { Authorization: `Bearer ${token}` } }
                  )
                  .then(function (verifyRes) {
                    if (verifyRes.data.success) {
                      alert("Payment Successful! You are now a Premium User.");
                      window.location.reload();
                    } else {
                      alert("Payment verification failed.");
                    }
                  });
              },
              theme: { color: "#6b9bd1" },
            };

            const rzp = new Razorpay(options);
            rzp.open();
          })
          .catch(function (error) {
            console.error("Payment error:", error);
            alert("Error initiating payment.");
          });
      }

      function fetchLeaderboard() {
        if (!requireAuth("view leaderboard")) return;

        axios
          .get("http://localhost:3000/premium/leaderboard", {
            headers: { Authorization: `Bearer ${token}` },
          })
          .then(function (res) {
            const leaderboardList = document.getElementById("leaderboardList");
            leaderboardList.innerHTML = "";

            const data = res.data.leaderboard || [];

            data.forEach(function (item, index) {
              const li = document.createElement("li");
              li.textContent = `${index + 1}. Name â†’ ${
                item.name
              } | Total Exp â†’ ${item.totalAmount}`;
              leaderboardList.appendChild(li);
            });
          })
          .catch(function (err) {
            console.error("Error fetching leaderboard:", err);
            if (err.response && err.response.status === 403) {
              alert("Leaderboard is only for premium users.");
            }
          });
      }

      function goToPreviousPage() {
        if (!requireAuth("navigate expenses")) return;
        if (currentPage > 1) {
          currentPage--;
          localStorage.setItem("currentPage", currentPage);
          getExpenses();
        }
      }

      function goToNextPage() {
        if (!requireAuth("navigate expenses")) return;
        currentPage++;
        localStorage.setItem("currentPage", currentPage);
        getExpenses();
      }

      function changePageSize() {
        if (!requireAuth("change page size")) return;
        pageSize = parseInt(document.getElementById("pageSizeSelector").value);
        localStorage.setItem("pageSize", pageSize);
        currentPage = 1;
        localStorage.setItem("currentPage", currentPage);
        getExpenses();
      }

      form.addEventListener("submit", addExpense);
      document
        .getElementById("premiumBtn")
        .addEventListener("click", initiatePremiumPayment);
      document
        .getElementById("showLeaderboardBtn")
        .addEventListener("click", fetchLeaderboard);
      document
        .getElementById("downloadexpense")
        .addEventListener("click", download);
      document
        .getElementById("prevPage")
        .addEventListener("click", goToPreviousPage);
      document
        .getElementById("nextPage")
        .addEventListener("click", goToNextPage);
      document
        .getElementById("pageSizeSelector")
        .addEventListener("change", changePageSize);

      checkAuthStatus();
    </script>
  </body>
</html>
